language: python
python: 3.6
sudo: required
matrix:
  include:
    #  when use openssl@1.1, ERROR: The Python ssl extension was not compiled. Missing the OpenSSL lib?
    #- os: osx
    #  osx_image: xcode11
    #  language: generic
    #  env: PYTHON_VERSIONS=3.4-dev
    - os: osx
      osx_image: xcode11
      language: generic
      env: PYTHON_VERSIONS=3.5-dev
    - os: osx
      osx_image: xcode11
      language: generic
      env: PYTHON_VERSIONS=3.6-dev
    - os: osx
      osx_image: xcode11
      language: generic
      env: PYTHON_VERSIONS=3.7-dev
    - os: osx
      osx_image: xcode11
      language: generic
      env: PYTHON_VERSIONS=3.8-dev
    - services:
        - docker
      env: DOCKER_IMAGE=quay.io/pypa/manylinux1_x86_64
           PLAT=manylinux1_x86_64
    - services:
        - docker
      env: DOCKER_IMAGE=quay.io/pypa/manylinux1_i686
           PRE_CMD=linux32
           PLAT=manylinux1_i686
    - services:
        - docker
      env: DOCKER_IMAGE=quay.io/pypa/manylinux2010_x86_64
           PLAT=manylinux2010_x86_64

install:
  - |
    if [ -n "$DOCKER_IMAGE" ]; then
      docker pull $DOCKER_IMAGE
    #else
      # for using openssl because pyenv choose openssl@1.1 than openssl (python-build:use_homebrew_openssl)
      # when use openssl@1.1, ERROR: The Python ssl extension was not compiled. Missing the OpenSSL lib?
      #brew uninstall --ignore-dependencies openssl@1.1
      #brew install openssl
    fi
script:
  - |
    if [ -n "$DOCKER_IMAGE" ]; then
      docker run --rm -e PLAT=$PLAT -v `pwd`:/io $DOCKER_IMAGE /io/ci/build-wheels-using-docker.sh
    else
      ./ci/build-wheels-using-mac.sh
    fi
before_deploy:
  - |
    if [ -n "$DOCKER_IMAGE" ]; then
      cd build/python
      sudo chown -R travis:travis /home/travis/
      rm dist/*
      cp wheelhouse/* dist/.
    else
      brew install openssl@1.1
      python -m pip install -r python/requirements-dev.txt
      cd build/python
    fi
deploy:
  provider: pypi
  server: https://test.pypi.org/legacy/
  user: "ksgwr"
  password:
    secure: "IbT27H/+ysN1U7z9TDTQDED4Md4qOJMrTqf7iaDtkKfPG+2rpyLsExwvf9NYZAsXf7oXvZ97e5C94vBgAvtMe2Jc5sUn5ymIQKpxaPF0xxdhNFrwibOvACbwYU/J9EeHQSNdyg9TI6WTflAawpLnQOSCVQPEf8zl+G9XKNwT2tHcxJKZGinRkZLXpwb5anV9naHfypynj3Wco9i694QCegAZ6Z5Izoev+fvYR2PC2hue/FstYw+pJ8gl4j36VXoewBpbjIpGxL+iWZi035Ngu7rwzPNFT3DWYDjPBMuH5qr0spuKN/UISWhvGGe55SsaEAWVGYOIyg9ExTGq8e44NkSvaem0IoXAmUwMsgzyEErcFvyGUzKZDAaOOYDgL2rt0dWAkw/jQyI05LAeGzsfLQpNQlveV2I5inQHJcij5TBGxFGyQji/TO3vr7tF8C7AiuSyE1wdnpUIMoOGBi25wN0R8ubreS/c3wbs719OunlzkiLcljhL1TEGPgrSeT2Bsj4jlwGIkihFZHYvMezDNd3flxaV3JvR9CD22tfUXoZHDTobSlikCtTVh7W2Ckx0da2lWUhm6cNNCLAHtW0sYWd2BG9pCwC16PFike8ZBvlLSgplIJdO/aNvjtDOOv6VG2TPnAZkCSJZlNnQMfw6eGeMsjetJgZ7OIifyJ39JKU="
  #on:
  #  tags: true
  distributions: "bdist_wheel"
  skip_cleanup: true
  skip_existing: true
